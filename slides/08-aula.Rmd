---
class: inverse 
title: "<b>Metodologias Informacionais com R</b>"
subtitle: "<br/>Modulo IV: PNAD Contínua do IBGE"
author: "<br/><b>Telmo dos Santos Klipp</b> (telmo.klipp@inpe.br)<br/>"
output:
  xaringan::moon_reader:
    css: [default, ninjutsu, ki-fonts, my-theme.css]
    yolo: false
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideClass: ["left", "top"]
      slideNumberFormat: "%current%"
      ratio: '16:9' # 
---
layout: true

background-image: url(figures/template_middlepage_2.png)
background-size: cover

```{r libririesandcustoms, include=FALSE, warning=FALSE}
  library(xaringanthemer)
  library(icons)
  colors = c(
    red = "#f34213",
    purple = "#3e2f5b",
    orange = "#ff8811",
    green = "#136f63",
    white = "#FFFFFF",
    midnightblue = "#191970"
  )
```

---
### .orange[`r icons::fontawesome("info-circle")` Informações Gerais sobre o Curso]

- <p class="jst">Materiais disponibilizados via <A href="https://classroom.google.com/u/0/c/NjExMjg5MTU0OTY3">Classroom</A>;</p> 
- <p class="jst">O aprendizado requer a prática que será constante nas aulas;</p>

.pull-left[
Bibliografia Básica:

 .tiny2[- <p class="jst">Kennedy, R., & Waggoner, P. D. (2021). Introduction to r for social scientists: a tidy programming approach. CRC Press.</p>

```{r out.width = '39%', echo=FALSE, fig.align = "center"}
knitr::include_graphics("figures/basicblibliograph.png") 
```
]
]

.pull-right[
Bibliografia Complementar:

 .tiny2[- <p class="jst">Wickham, H., Çetinkaya-Rundel, M., & Grolemund, G. (2023). R for data science (2e): import, tidy, transform, visualize, and model data. "O'Reilly Media, Inc.". Disponível em: <A href="https://r4ds.hadley.nz/">https://r4ds.hadley.nz/</A>. Acesso em: 14 de junho, 2023. (Online) </p>
- <p class="jst">Damiani, A. et. al., (2022). Ciência de Dados em R. Curso-R. Disponível em: <A href="https://livro.curso-r.com">https://livro.curso-r.com</A>. Acesso em: 12 de maio, 2023. (Online)</p>
-  <p class="jst">de Aquino, J. A. (2014). R para cientistas sociais. Editora da UESC (editus). Disponível em: <A href="http://www.uesc.br/editora/index.php?item=conteudo_livros_digitais.php">http://www.uesc.br/editora/</A>. Acesso em: 12 de maio, 2023. </p>
-  <p class="jst">de Oliveira, P. F., Guerra, S., McDonnell, R. (2018). Ciência de Dados com R: Introdução. Editora IBPAD. Disponível em: <A href="https://cdr.ibpad.com.br/index.html">https://cdr.ibpad.com.br/index.html</A>. Acesso em: 12 de maio, 2023. (Online) </p> ] 
]

---
### .orange[`r icons::fontawesome("table")` Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")`]

<p class="jst">A <A href="https://www.ibge.gov.br/estatisticas/sociais/trabalho/17270-pnad-continua.html?=&t=o-que-e
">Pesquisa Nacional por Amostra de Domicílios Contínua (PNADC)</A>  realizada pelo Instituto Brasileiro de Geografia e Estatística (IBGE) visa:</p>

> <p class="jst"><i>"Acompanhar as flutuações trimestrais e a evolução, no curto, médio e longo prazos, da força de trabalho, e outras informações necessárias para o estudo do desenvolvimento socioeconômico do País."</i> (IBGE)</b> 

Algumas características da PNAD Contínua:

- <p class="jst">As pesquisas possuem periodicidade mensal (dada por trimestre móvel), trimestral, anual e variável (feita com maior periodicidade ou ocasionalmente).</p>
- <p class="jst">As pesquisas apresentam uma amostragem complexa, seguindo um plano amostral cuja seguinte <A href="https://ftp.ibge.gov.br/Trabalho_e_Rendimento/Pesquisa_Nacional_por_Amostra_de_Domicilios_continua/Notas_metodologicas/notas_metodologicas.pdf"> nota </A> do IBGE detalha informações  - ex: extratificação, seleção e rotação de amostras, seleção de domicílios, cálculos de pesos de amostras e domicílios, estimadores e precisão.</p>

---
### .orange[`r icons::fontawesome("table")` Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")`]

<p class="jst">Para trabalhar com os microdados da PNAD Contínua vamos fazer uso dos pacotes: </p>

- <A href="https://cran.r-project.org/web/packages/PNADcIBGE/index.html">.purple[<b>PNADcIBGE</b>]</A> - possibilita baixar dados da PNAD Contínua.
- <A href="https://cran.r-project.org/web/packages/survey/index.html">.purple[<b>survey</b>]</A> - possibilita produzir diversas operações estatísticas em dados com amostragem complexa.
- <A href="https://cran.r-project.org/web/packages/srvyr/index.html">.purple[<b>srvyr</b>]</A> - uma extensão do pacote .purple[<b>survey</b>] que permite o uso de funções do .purple[<b>dplyr</b>] e sua sintaxe.


É necessário a instalação de:

```{r, message=FALSE, eval=FALSE}
  install.packages(c("PNADcIBGE", "survey", "srvyr", "tidyverse"))
  # Outros pacotes que serão usados
  install.packages(c("kableExtra", "patchwork"))
```

E carregar alguns dos referidos pacotes:

```{r, message=FALSE}
  library(PNADcIBGE)
  library(survey)
  library(tidyverse)
  library(kableExtra)
  library(patchwork)
```

```{r, echo=FALSE}
options(OutDec=",", scipen=100, digits=4, big.mark = ".")
```


---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Permite a importação e a análise de dados amostrais (microdados) da PNAD Contínua do IBGE. A importação ou carregamento de dados pode ser feita de duas formas:</p>

- <b>Online</b> - usando a função  .purple[get_pnadc()]
  - <p class="jst">Observe <b>?get_pnadc</b></p>
  - <p class="jst">Na requisição dos microdados com .purple[get_pnadc()] são baixados arquivos de um servidor <b>FTP</b> do IBGE. Estes são: o arquivo com os microdados e os arquivos com a documentação necessária ao processamento e leitura desses dados (<i>input</i>, dicionários, variáveis de deflação).</p> 
- <b>Offline</b> - (dados previamente baixados) - usando a função  .purple[read_pnadc()]
  - <p class="jst">Observe <b>?read_pnadc</b></p>
  - <p class="jst">Essa função permite ler diretamente o arquivo contendo os microdados, dado um arquivo de <i>input</i> (um programa de leitura na linguagem SAS) fornecido pelo IBGE.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

Existem divisões nos microdados da PNAD Contínua. Portanto, é possível baixá-los de quatro formas básicas:

- Dados trimestrais usando o parâmetro <b>quarter</b> que permite baixar um trimestre (1 à 4) por vez.
```{r, eval=FALSE}
  dados_2022q4 <- get_pnadc(year = 2022, quarter = 4)
```
- Dados anuais acumulados em determinada visita (entre a 1ª e 5ª cada vez) usando o parâmetro <b>interview</b>.
```{r, eval=FALSE}
  dados_2022_interview_1 <- get_pnadc(year = 2022, interview = 1)
```
- Dados anuais concentrados em determinado trimestre (entre o 1º e 4º cada vez) usando o parâmetro <b>topic</b>.
```{r, eval=FALSE}
  dados_2022_anual_trimestre <- get_pnadc(year=2022, topic=2)
```
- Dados de temas e tópicos suplementares (questionários específicos) aplicados a morador selecionado.
```{r, eval=FALSE}
  # Dados do módulo de Sensação de Segurança aplicado ao morador selecionado no 4º trimestre.
  dados_2022_anual_trimestre <- get_pnadc(year=2022, topic=4, selected=TRUE)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

Outros argumentos da função .purple[get_pnadc()] são:

- <b>vars</b>: Permite carregar apenas variáveis específicas, mantendo-se aquelas relacionadas ao plano amostral.

```{r, eval=FALSE}
  # Obtendo as  variáveis:
  #  VD4001 - Condição em relação à força de trabalho
  #  VD4002 - Condição de ocupação
  dados_2022q4 <- get_pnadc(year = 2022, quarter = 4, vars=c("VD4001","VD4002"))
```
- <b>labels</b> (lógico `TRUE` ou `FALSE`): incluir ou não nomes categóricos nos valores de determinadas variáveis.

- <b>deflator</b> (lógico `TRUE` ou `FALSE`): incluir ou não as variáveis que permitem aplicar deflacionamento.

- <b>design</b> (lógico `TRUE` ou `FALSE`): aplica ou não o plano amostral (<b>`survey.design`</b> ou <b>`svyrep.design`</b>).

- <b>defyear</b> e <b>defperiod</b>: Ano ou trimestre considerados nas variáveis de deflacionamento, respectivamente. Se <b>defyear</b> ou <b>defperiod</b> forem indicados como `NULL` e o <b>deflator</b> como `TRUE`, será considerado o ano mais recente, o ano ou o trimestre dos dados, conforme a alternativa de requisição de dados usada.

- <b>savedir</b>: Diretório para salvar os microdados e a documentação necessária ao processamento e leitura.

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Vamos trabalhar com microdados do primeiro trimestre de 2023. Para baixar os dados de um trimestre do servidor do IBGE através do pacote .purple[<b>PNADcIBGE</b>], procedemos na forma:</p>

```{r, cache=TRUE, eval=FALSE}
  pnadc_2023q1 <- get_pnadc(year = 2023, quarter = 1)
```

<p class="jst">Lembrando que como se trata de uma quantidade considerável de dados, podemos escolher carregar apenas variáveis específicas como  ano (<b>Ano</b>), unidade da federação (<b>UF</b>), condição de ocupação (<b>VD4002</b>), entre outras. Não obstante, as variáveis necessárias ao plano amostral (pesos dos domicílios, domínios e índices de projeção geográfica, sexo e idade) são mantidas no conjunto de dados. Veja o exemplo:</p>

```{r, eval=FALSE}
  pnadc_2023q1 <- get_pnadc(year = 2023, quarter = 1,
                                  vars = c("Ano","Trimestre","UF","Capital","Estrato","UPA",
                                           "posest","V1027","V1028","V1029", "2003", "2007",
                                           "V2009", "VD3004", "VD3005","VD4002", "VD4020",
                                           "VD4035", "ID_DOMICILIO","Habitual","Efetivo"))
```

<p class="jst">O objeto retornado é do tipo  <b>svyrep.design</b>, pois vai incluir o plano amostral com pesos replicados por reamostragem do tipo <i>bootstrap</i> (para maiores informações, veja o <A href="https://guilhermejacob.github.io/2021/12/pnadc-raking-bootstrap/"> artigo</A>). Também incluirá os <i>labels</i> categóricos e as variáveis de deflacionamento.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Conforme mencionado, caso os dados dados da PNAD Contínua já tenham sido baixados, pode-se carregá-los (<i>offline</i>) com a função .purple[read_pnadc()]. Para isso basta informar o arquivo dos microdados (ex: PNADC_012023.txt) e o arquivo de <i>input</i> (um programa de leitura na linguagem SAS).</p>

```{r chunk1, cache=TRUE, include=FALSE}
  # Lendo algumas variáveis
  pnadc_2023q1 <- read_pnadc(microdata="../dados/PNADC20231/PNADC_012023.txt",
                             input_txt="../dados/PNADC20231/input_PNADC_trimestral.txt",
                             vars = c("Ano", "Trimestre", "UF", "Capital", "Estrato", "UPA",
                                      "posest", "V1027", "V1028", "V1029", "2003", "V2007",
                                      "V2009", "VD3004", "VD3005", "VD4002", "VD4020", "VD4035"))
  class(pnadc_2023q1)
```

```{r, cache=TRUE, eval=FALSE}
  pnadc_2023q1 <- read_pnadc(microdata="PNADC20231/PNADC_012023.txt",
                             input_txt="PNADC20231/input_PNADC_trimestral.txt",
                             vars = c("Ano", "Trimestre", "UF", "Capital", "Estrato", "UPA",
                                      "posest", "V1027", "V1028", "V1029", 
                                      "V2003","V2009", "V2007", "VD3004", "VD3005",
                                      "VD4002", "VD4020", "VD4035"))
  class(pnadc_2023q1)
```

<p class="jst">Os dados serão retornados em um objeto do tipo <b>tibble</b>, porém, serão mantidas as variáveis relacionadas ao plano amostral, incluso os pesos replicados (de <b>V1028001</b> à <b>V1028200</b>) que foram gerados na reamostragem por <i>bootstrap</i>. A princípio, para considerar o plano amostral nas estatísticas, temos duas possibilidades: </p>

- <p class="jst">Construir um objeto do tipo <b>survey.design</b>, contendo as informações de estratificação e os pesos finais.</p>
- <p class="jst">Construir um objeto do tipo <b>svyrep.design</b>, contendo as informações de estratificação e os pesos replicados.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Para gerar o plano amostral com objeto do tipo <b>survey.design</b>, não precisamos dos pesos replicados (de <b>V1028001</b> à <b>V1028200</b>), que podem ser excluídos. Manteremos algumas variáveis relacionadas à estratificação, os pesos finais e as variáveis que desejamos trabalhar, conforme uma das opções:</p>

```{r chunk2, cache=TRUE}
  pnadc_2023q1 <- select(pnadc_2023q1, -(V1028001:V1028200)) # Excluí pesos replicados, ou
```

```{r eval=FALSE}
  pnadc_2023q1 <- pnadc_2023q1 |> 
    select(Ano, Trimestre, UF, Capital, Estrato, UPA, posest, V1027, V1028, V1029,
           V2003, V2007, V2009, VD3004, VD3005, VD4002, VD4020, VD4035, ID_DOMICILIO) 
```

<p class="jst">Dentre as variáveis escolhidas, estão:</p>

- Peso do domicílio e das pessoas, sem calibração (<b>V1027</b>) e com calibração (<b>V1028</b>).
- Projeção da população por níveis geográficos (<b>V1029</b>) e domínios de projeção geográficos (<b>posest</b>).
- Número de ordem (<b>V2003</b>).
- Identificação do domicílio (<b>ID_DOMICILIO</b>).

<p class="jst">Para gerar o plano amostral com objeto do tipo <b>svyrep.design</b>, podemos ler os dados filtrando as variáveis de interesse, mas sem excluir os pesos replicados, conforme foi realizado no <i>slide</i> anterior.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Agora, podemos aplicar as demais operações aos dados para:</p>

- <p class="jst">Obter os <i>labels</i> categóricos em determinadas variáveis.</p>
- <p class="jst">Obter as variáveis de deflacionamento.</p>
- <p class="jst">Transformar o objeto do tipo <b>tibble</b> para <b>survey.design</b> ou <b>svyrep.design</b>, caso seja de interesse obter estatísticas considerando o plano amostral com o pacote .purple[<b>survey</b>].</p> 

<p class="jst">Essas operações são possíveis através das funções .purple[pnadc_labeller()], .purple[pnadc_deflator()] e  .purple[pnadc_design()], sendo que ...</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">... procedemos na forma:</p>

```{r chunk3, cache=TRUE, include=FALSE}
  # Atribuindo labels as variáveis categóricas
  pnadc_2023q1 <- pnadc_labeller(
    data_pnadc=pnadc_2023q1,
    dictionary.file="../dados/PNADC20231/dicionario_PNADC_microdados_trimestral.xls"
  )
  # Carregando indicadores de deflação caso deseja-se obter variáveis de rendimento
  # em valor real.
  pnadc_2023q1 <- pnadc_deflator(
    data_pnadc=pnadc_2023q1,
    deflator.file="../dados/PNADC20231/deflator_PNADC_2023_trimestral_040506.xls"
  )
  # Criação do plano amostral para obter estatísticas coerentes com o pacote 'survey'
  pnadc_2023q1 <- pnadc_design(data_pnadc=pnadc_2023q1)
```

```{r cache=TRUE, eval=FALSE}
  # Atribuindo labels as variáveis categóricas
  pnadc_2023q1 <- pnadc_labeller(
    data_pnadc=pnadc_2023q1,
    dictionary.file="PNADC20231/dicionario_PNADC_microdados_trimestral.xls"
  )
  # Carregando indicadores de deflação caso deseja-se obter variáveis de rendimento
  # em valor real.
  pnadc_2023q1 <- pnadc_deflator(
    data_pnadc=pnadc_2023q1,
    deflator.file="PNADC20231/deflator_PNADC_2023_trimestral_040506.xls"
  )
  # Criação do plano amostral para obter estatísticas coerentes com pacote 'survey'
  pnadc_2023q1 <- pnadc_design(data_pnadc=pnadc_2023q1)
```

<p class="jst">A função .purple[pnadc_design()] aplica o plano amostral gerando objeto do tipo  <b>survey.design</b> ou <b>svyrep.design</b> (caso os pesos replicados sejam mantidos) usando internamente as funções .purple[survey::svydesign()] ou .purple[survey::svrepdesign()]. Agora, vejamos ...</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst"> ... o tipo do nosso objeto:</p>

```{r, cache=TRUE, eval=TRUE}
  class(pnadc_2023q1)
```

Esse objeto é uma lista cujos elementos são:

```{r, cache=TRUE, eval=TRUE}
  names(pnadc_2023q1)
```

No item "variables" está o objeto <b>tibble</b> com os microdados. Os nomes das variáveis disponíveis podem ser obtidos com:

```{r, cache=TRUE, eval=FALSE}
  names(pnadc_2023q1$variables)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Os arquivos de microdados e auxiliares (input, dicionários, indicadores de deflação) usados para aplicar as operações anteriores são fornecidos pelo IBGE.</p>

<p class="jst">Esses arquivos podem ser obtidos no <A href="https://www.ibge.gov.br/estatisticas/sociais/trabalho/17270-pnad-continua.html?=&t=downloads">.purple[site]</A> ou em servidor <b>ftp</b> do IBGE (<A href="https://ftp.ibge.gov.br">.purple[https://ftp.ibge.gov.br]</A>).</p>

<p class="jst">No entanto, é muito mais cômodo obtê-los fazendo uma requisição com a função .purple[get_pnadc()]. Nesse caso, não é necessário procurar os dados desejados na hierarquia de pastas do referido site ou do servidor <b>ftp</b>.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst">Relembrando:</p>

- A função  .purple[get_pnadc()] permite:
  - <p class="jst">Baixar os dados de servidor <b>FTP</b>.</p>
  - <p class="jst">Inclui por padrão <i>labels</i> categóricos, variáveis de deflacionamento e plano amostral. A não inclusão requer o uso de parâmetros específicos da função.</p> 
- A função  .purple[read_pnadc()] permite:
  - <p class="jst">Ler os microdados, requerendo arquivos específicos.</p>
  - <p class="jst">A inclusão de <i>labels</i> categóricos, variáveis de deflacionamento e plano amostral requer o uso de funções auxiliares.</p>
- <p class="jst">Os objetos  <b>survey.design</b> (usa método do conglomerado primário) e <b>svyrep.design</b> (usa método <i>bootstrap</i>) não devem apresentar diferenças nos resultados para uma mesma estimativa (ex: média ou proporção de uma variável). No entanto, como possuem métodos diferentes para estimar as variâncias, os resultados para estimativas de erros como désvio padrão ou intervalo de confiança podem diferir.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - pacote .purple[<b>PNADcIBGE</b>]]

<p class="jst"> O plano amostral é necessário para obter estatísticas coerentes e métricas sobre essas estatísticas como intervalos de confiança e margem de erro. Para maiores informações, veja as seguintes vídeo-aulas sobre microdados:</p>

- <A href="https://youtu.be/k3rLK8V_38s"> Vídeo 1 - teórico</A>

- <A href="https://www.youtube.com/watch?v=qC22jz0FA0U"> Vídeo 2 - sobre PNADC</A>

- <A href="https://www.youtube.com/watch?v=hhNA8MR__aA"> Vídeo 3 - sobre Pesquisa de Orçamentos Familiares (POF)</A>

<p class="jst"> O plano amostral da PNAD Contínua considera dois estágios de seleção com <b>estratificação</b> das unidades primárias de amostragem (UPAs). Não obstante, para produzir estatísticas coerentes sobre os dados, temos algumas opções:</p>

- <p class="jst">Usar o pacote .purple[<b>survey</b>], porém, seu objeto do tipo lista não permitirá operações usando o .purple[<b>dplyr</b>], devendo-se usar outras opções para manipulação de dados.</p>
- <p class="jst">Considerar as devidas métricas do plano amostral como, por exemplo, aplicar manualmente os devidos pesos da estratificação em funções pertinentes para gerar as estatíticas desejadas.</p>
- <p class="jst">Usar de forma combinada o pacote .purple[<b>survey</b>] e .purple[<b>srvyr</b>] o que permitirá o uso de funções do .purple[<b>dplyr</b>] e consequente flexibilidade nas manipulações de dados.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

<p class="jst">O objeto do tipo <b>survey.design</b> permite produzir estatísticas através de funções do pacote .purple[<b>survey</b>]. Por exemplo, quando se trata de uma variável categórica, a função .purple[svymean()] cálcula/estima a proporção entre os entrevistados para cada nível encontrado (ex: ocupados, desocupados) com projeção geográfica conforme a consulta. Vejamos:</p>

Qual a taxa de Ocupados/Desocupados em nível nacional?

```{r chunk4, cache=TRUE}
  svymean(~VD4002, pnadc_2023q1, na.rm=T)
```

Como gerar intervalos de confiança da proporção de Ocupados/Desocupados?

```{r chunk5, cache=TRUE}
  confint(svymean(~VD4002, pnadc_2023q1, na.rm=T), level=.99)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

Qual a taxa de Ocupados/Desocupados no Rio Grande do Sul? 

```{r chunk6, cache=TRUE}
  svymean(~VD4002, subset(pnadc_2023q1, UF=='Rio Grande do Sul'), na.rm=T)
```

Como gerar intervalos de confiança da proporção de Ocupados/Desocupados?

```{r chunk7, cache=TRUE}
  confint(svymean(~VD4002, subset(pnadc_2023q1, UF=='Rio Grande do Sul'), na.rm=T), level=.99)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

A função .purple[svytotal()] cálcula/estima o total entre os entrevistados para cada nível encontrado, projetando a estimativa geograficamente conforme a consulta. Vejamos:

Qual o total de Ocupados/Desocupados no Rio Grande do Sul?

```{r chunk8, cache=TRUE}
  svytotal(~VD4002, subset(pnadc_2023q1, UF=='Rio Grande do Sul'), na.rm=T)
```

Como gerar intervalos de confiança do total de Ocupados/Desocupados?

```{r chunk9, cache=TRUE}
  confint(svytotal(~VD4002, subset(pnadc_2023q1, UF=='Rio Grande do Sul'), na.rm=T), level=.99)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

<p class="jst">A variável <b>V2009</b> refere-se a idade dos entrevistados, enquanto <b>VD3005</b> é uma variável categórica referente a quantidade de anos de estudo. É possível extrair a informação da quantidade de anos de estudo do texto de cada nível categórico (ver a tabela abaixo). Perceba que da categoria "<b>Sem instrução e menos de 1 ano de estudo</b>" extrai-se o texto '1', assim, este nível pode ser ignorado em estimativas ou atribuído o valor 0.</p>

```{r chunk10, cache=TRUE}
  data.frame(VD3005 = pnadc_2023q1$variables$VD3005 ,
             qtd = gsub("\\D", "", pnadc_2023q1$variables$VD3005)) |> unique() |> 
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "240px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

<p class="jst"> Quando trabalhamos com variáveis numéricas, a função .purple[svymean()] cálcula/estima  a média, ao invés da proporção. Portanto, podemos extrair os anos de estudo de <b>VD3005</b>, converter para "numeric", e estimar a média de anos de estudo da população de 25 anos ou mais de idade no Rio Grande do Sul, conforme:</p>

```{r chunk11, cache=TRUE}
  svymean(~as.numeric(gsub("\\D", "", VD3005)), 
          subset(pnadc_2023q1, V2009 >= 25 & UF=='Rio Grande do Sul' 
                 & VD3005 != "Sem instrução e menos de 1 ano de estudo"), na.rm = T)
```

```{r chunk12, cache=TRUE}
  confint(svymean(~as.numeric(gsub("\\D", "", VD3005)),
                  subset(pnadc_2023q1, V2009 >= 25 & UF=='Rio Grande do Sul'
                         & VD3005 != "Sem instrução e menos de 1 ano de estudo"), na.rm = T),
          level=.99)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

 Qual é a média de anos de estudos da população de 25 anos ou mais de idade na capital Porto Alegre?
 
```{r chunk13, cache=TRUE}
  svymean(~as.numeric(gsub("\\D", "", VD3005)),
          subset(pnadc_2023q1, V2009 >= 25 & Capital=="Município de Porto Alegre (RS)"
                 & VD3005 != "Sem instrução e menos de 1 ano de estudo"), na.rm = T)
```

```{r chunk14, cache=TRUE}
  confint(svymean(~as.numeric(gsub("\\D", "", VD3005)), 
                  subset(pnadc_2023q1, V2009 >= 25 & Capital=="Município de Porto Alegre (RS)"
                         & VD3005 != "Sem instrução e menos de 1 ano de estudo"), na.rm = T),
          level=.99)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
 <p class="jst"> A função .purple[svyby()] permite estimar quantidades considerando agrupamentos. Vejamos a proporção em cada nível de instrução para cada sexo, conforme:</p>

```{r chunk_svyby1, cache=TRUE}
  svyby(formula=~VD3004, by=~V2007, design=pnadc_2023q1, FUN=svymean, na.rm=TRUE) |>
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "250px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
 <p class="jst">Vejamos o rendimento médio mensal por estado:</p>

```{r chunk_svyby2, cache=TRUE}
 svyby(formula=~VD4020, by=~UF, design=pnadc_2023q1, FUN=svymean, na.rm=TRUE) |>
  arrange(desc(VD4020)) |>
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "305px")
```


---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
 <p class="jst"> A função .purple[svytable()] permite produzir tabelas com valores totais de uma variável considerando tabulamento cruzado (múltiplas variáveis). Vejamos as estimativas da população total em cada sexo por estado:</p>

```{r chunk_svytable1, cache=TRUE}
 svytable(~UF + V2007, design = pnadc_2023q1) |>
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "304px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
 <p class="jst"> Vejamos as estimativas dos totais da popolação ocupada/desocupada em cada estado:</p>

```{r chunk_svytable2, cache=TRUE}
 svytable(~UF + VD4002, design = pnadc_2023q1) |>
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "330px")
```


---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
 <p class="jst"> Também é possível obter a proporção com auxilio da função .purple[prop.table()] do .purple[<b>rbase</b>]:</p>

```{r chunk_svytable3, cache=TRUE}
 prop.table(svytable(~UF + VD4002, design = pnadc_2023q1), margin = 1) |>
  kable() |> 
  kable_styling(bootstrap_options = c('striped', 'condensed')) |>
  scroll_box(width = "1050px", height = "330px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]

 <p class="jst">O pacote .purple[<b>survey</b>] possui outras funções como .purple[svyvar()], .purple[svyratio()], .purple[svyquantile()], entre outras. Também possui funções para gerar gráficos como .purple[svyplot()], .purple[svyhist()] e .purple[svysmooth()]. Veja os exemplos:</p>
 
```{r chunk15, cache=TRUE, fig.align='center', out.height="330px", out.width="530px"}
  svyhist(formula=~V2009, design=pnadc_2023q1, freq=TRUE,
          main="Histograma", xlab="Idade do morador na data de referência")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
```{r chunk15a, cache=TRUE, fig.align='center', out.height="400px", out.width="700px"}
  svyhist(formula=~VD4035, design=pnadc_2023q1,
          main="Histograma", xlab="Número de Horas Trabalhadas")
```
 
---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>survey</b>]]
 
```{r chunk15b, cache=TRUE, fig.align='center', out.height="380px", out.width="580px"}
  svyplot(formula=V2009~VD4035, design = pnadc_2023q1,
                  style="grayhex", xlab="Número de Horas Trabalhadas",
                  ylab="Idade do morador na data de referência")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

Nos próximos exemplos trabalharemos com os seguintes dados:

```{r, eval=FALSE}
  pnadc2023_1trim <- get_pnadc(2023, quarter = 1, design = FALSE, labels = T, 
                             vars = c("Ano","Trimestre","UF", "Capital","UPA",
                                      "Estrato", "posest", "V1027","V1028", "V1029",
                                      "V2003","V2007","V2009","V2010",
                                      "V3007","VD3004","VD3005",
                                      "VD4001","VD4002","VD4005","VD4020",
                                      "Habitual", "Efetivo"))
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

Para carregar diretamente:

```{r chunk16, cache=TRUE, include=FALSE}
  pnadc2023_1trim <- read_pnadc(microdata="../dados/PNADC20231/PNADC_012023.txt",
                             input_txt="../dados/PNADC20231/input_PNADC_trimestral.txt",
                             vars = c("Ano","Trimestre","UF", "Capital","UPA",
                                      "Estrato", "posest", "V1027","V1028", "V1029",
                                      "V2003","V2007","V2009","V2010",
                                      "V3007","VD3004","VD3005",
                                      "VD4001","VD4002","VD4005","VD4020"))
  pnadc2023_1trim <-  pnadc2023_1trim |>
    mutate(code_state = as.numeric(UF))
  pnadc2023_1trim <- pnadc_labeller(
    data_pnadc=pnadc2023_1trim,
    dictionary.file="../dados/PNADC20231/dicionario_PNADC_microdados_trimestral.xls"
  )
  pnadc2023_1trim <- pnadc_deflator(
    data_pnadc=pnadc2023_1trim,
    deflator.file="../dados/PNADC20231/deflator_PNADC_2023_trimestral_040506.xls"
  )
```

```{r, cache=TRUE, eval=FALSE}
  # Ler os dados
  pnadc2023_1trim <- read_pnadc(microdata="PNADC20231/PNADC_012023.txt",
                             input_txt="PNADC20231/input_PNADC_trimestral.txt",
                             vars = c("Ano","Trimestre","UF", "Capital","UPA",
                                      "Estrato", "posest", "V1027","V1028", "V1029",
                                      "V2003","V2007","V2009","V2010",
                                      "V3007","VD3004","VD3005", 
                                      "VD4001","VD4002","VD4005","VD4020"))
  pnadc2023_1trim <-  pnadc2023_1trim |>
    mutate(code_state = as.numeric(UF)) # Manter códigos dos estados 
```
<p class="jst"> Não vamos excluir os pesos replicados para obter um objeto do tipo <b>svyrep.design</b>, posteriormente. Para atribuir <i>labels</i> categóricos e obter variáveis de deflação procedemos ...</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

```{r cache=TRUE, eval=FALSE}
  # obtendo labels categóricos e variáveis de deflação
  pnadc2023_1trim <- pnadc_labeller(
    data_pnadc=pnadc2023_1trim,
    dictionary.file="PNADC20231/dicionario_PNADC_microdados_trimestral.xls" 
  )
  pnadc2023_1trim <- pnadc_deflator(
    data_pnadc=pnadc2023_1trim,
    deflator.file="PNADC20231/deflator_PNADC_2023_trimestral_040506.xls"
  )
  class(pnadc2023_1trim)
```

```{r chunk16b, cache=TRUE}
  class(pnadc2023_1trim)
```

 <p class="jst">Após as operações realizadas, o objeto <b>pnadc2023_1trim</b> será do tipo <b>tibble</b>, possibilitando o uso do .purple[<b>dplyr</b>] e .purple[<b>ggplot2</b>]. Na geração de estatísticas, podem ser consideradas funções ponderadas  - ex: .purple[weighted.mean()], .purple[weighted.median()] ou .purple[weighted.quantile()]. No entanto, as estatísticas geradas podem divergir daquelas obtidas com os pacotes .purple[<b>survey/srvyr</b>] pois não consideram algumas variáveis do plano amostral como o <b>Estrato</b>, entre outras.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

```{r chunk17, cache=TRUE}
  rendimento_mensal_estados <- pnadc2023_1trim |> 
    filter(VD3005 != "Sem instrução e menos de 1 ano de estudo") |>
    mutate(anos_de_estudo = as.numeric(gsub("\\D", "", VD3005))) |>
    summarise(rendimento_medio = weighted.mean(VD4020, w = V1028, na.rm = TRUE),
              anos_de_estudo = weighted.mean(anos_de_estudo, w = V1028, na.rm = TRUE),
              .by = "UF") |>
    drop_na() |>
    arrange(desc(rendimento_medio))
  rendimento_mensal_estados |> kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "210px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

.pull-left[
<p class="jst">Rendimento médio mensal e anos de estudo por estados.</p>

```{r p1a, message=FALSE, eval=FALSE}
  dt <- rendimento_mensal_estados |>
    mutate(
      UF = fct_reorder(UF, rendimento_medio)
    )
   p <- ggplot(dt) + theme_classic()
   p1 <- p + 
     geom_col(aes(rendimento_medio, UF))
   p2 <- p + 
     geom_col(aes(anos_de_estudo, UF)) +
     theme(axis.text.y = element_blank(),
           axis.title.y = element_blank())
   p1 + p2
```
]

.pull-right[
```{r p1a_out, ref.label="p1a", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

.pull-left[
<p class="jst">Rendimento médio mensal por anos de estudo em nível estadual.</p>
```{r p1b, message=FALSE, eval=FALSE}
  rendimento_mensal_estados |> 
    ggplot(aes(anos_de_estudo,
               rendimento_medio)) +
    geom_point() + 
    theme_classic()
```
]

.pull-right[
```{r p1b_out, ref.label="p1b", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

```{r chunk18, cache=TRUE}
  rendimento_mensal_capitais <- pnadc2023_1trim |>
    filter(VD3005 != "Sem instrução e menos de 1 ano de estudo") |>
    mutate(anos_de_estudo = as.numeric(gsub("\\D", "", VD3005))) |>
    summarise(rendimento_medio = weighted.mean(VD4020, w = V1028, na.rm = TRUE),
              anos_de_estudo = weighted.mean(anos_de_estudo, w = V1028, na.rm = TRUE),
              .by = "Capital") |>
    tidyr::drop_na() |>
    arrange(desc(rendimento_medio))
  rendimento_mensal_capitais |> kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "210px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

.pull-left[
<p class="jst">Rendimento médio mensal e anos de estudo nas capitais.</p>
```{r p2a, message=FALSE, eval=FALSE}
  dt <- rendimento_mensal_capitais |>
    mutate(
      Capital=fct_reorder(Capital,
                          rendimento_medio)
    )
   p <- ggplot(dt) + theme_classic()
   p1 <- p + 
     geom_col(aes(rendimento_medio,Capital))
   p2 <- p + 
     geom_col(aes(anos_de_estudo,Capital))+
     theme(axis.text.y = element_blank(),
           axis.title.y = element_blank())
   p1 + p2 
```
]

.pull-right[
```{r p2a_out, ref.label="p2a", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas manualmente]

.pull-left[
<p class="jst">Rendimento médio mensal por anos de estudo considerando as capitais.</p>
```{r p2b, message=FALSE, eval=FALSE}
  rendimento_mensal_capitais |> 
    ggplot(aes(anos_de_estudo,
               rendimento_medio)) +
    geom_point() + 
    theme_classic()
```
]

.pull-right[
```{r p2b_out, ref.label="p2b", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]

Vamos usar de forma combinada .purple[<b>survey</b>] e .purple[<b>srvyr</b>]. Antes, necessitamos carregar o pacote .purple[<b>srvyr</b>]:

```{r, message=FALSE}
  library(srvyr)
```

Agora, aplicaremos o plano amostral nos nossos dados para obter um objeto <b>svyrep.design</b>:

```{r chunk19a, cache=TRUE, message=FALSE}
  pnadc2023_1trim <- PNADcIBGE::pnadc_design(data_pnadc = pnadc2023_1trim)
  class(pnadc2023_1trim)
```

E tranformaremos novamente o objeto para poder trabalhar com .purple[<b>dplyr</b>] e .purple[<b>ggplot2</b>]:

```{r chunk19b, cache=TRUE, message=FALSE}
  pnadc2023_1trim <- srvyr::as_survey(.data = pnadc2023_1trim)
  class(pnadc2023_1trim)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]

Esse objeto continua sendo uma lista cujos elementos são:

```{r chunk20, cache=TRUE, eval=TRUE}
  names(pnadc2023_1trim)
```

No item "variables" está o objeto <b>tibble</b> com os microdados, as variáveis disponíveis são:

```{r chunk21, cache=TRUE, eval=FALSE}
  names(pnadc2023_1trim$variables)
```

Observe que é possível usar funções do pacote .purple[<b>dplyr</b>] no novo objeto:

```{r chunk22, cache=TRUE, eval=FALSE}
  glimpse(pnadc2023_1trim)
```

<p class="jst">Da mesma forma, funções de outros pacotes do .purple[<b>tidyverse</b>] podem ser usadas. Além disso, o pacote .purple[<b>srvyr</b>] possui funções próprias como .purple[survey_mean()], .purple[survey_ratio()], .purple[survey_total()], .purple[survey_count()], entre outras.</p>

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]

```{r chunk23, cache=TRUE}
  rendimento_mensal_estados <- pnadc2023_1trim |>
    group_by(UF) |>
    summarise(rendimento_medio = survey_mean(VD4020, na.rm = T, vartype = "ci"))
    rendimento_mensal_estados |>
      arrange(desc(rendimento_medio)) |>
  kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "250px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]

.pull-left[
<p class="jst">Rendimento médio mensal estimado por estados.</p>
```{r p3a, message=FALSE, eval=FALSE}
  rendimento_mensal_estados |> 
    ggplot(aes(UF, rendimento_medio)) +
    geom_point() +
    geom_errorbar(
      aes(ymin = rendimento_medio_low,
          ymax = rendimento_medio_upp),
      width = 0.2) +
    theme_classic() +
    theme(
      axis.text.x = element_text(angle = 90)
    )
```
]

.pull-right[
```{r p3a_out, ref.label="p3a", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]


```{r chunk24, cache=TRUE, warning=FALSE}
  proporcao_nivel_estudo <- pnadc2023_1trim |>
    group_by(V2007, VD3004) |>
    summarise(frequencia = survey_mean())
  proporcao_nivel_estudo |> 
    kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "250px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - estatísticas com .purple[<b>srvyr</b>]]

.pull-left[
<p class="jst">Proporção estimada da população em cada nível de estudo considerando <b>V2007</b>.</p>
```{r p4a, message=FALSE, eval=FALSE}
  proporcao_nivel_estudo |> 
    mutate(
      nivel_de_estudo = fct_reorder(
        VD3004, frequencia
      )
    ) |>
    drop_na() |>
    ggplot(aes(frequencia * 100,
               nivel_de_estudo)) +
    geom_col() +
    facet_wrap(~V2007, nrow = 2) +
    theme_minimal()
```
]

.pull-right[
```{r p4a_out, ref.label="p4a", echo=FALSE, warning=FALSE, message=FALSE}
```
]

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Relembrando]

- <p class="jst"><b>survey.design</b>/<b>svyrep.design</b> podem apresentar diferenças para estimativas de erros (ex: désvio padrão), mas as estimativas obtidas para variáveis como totais, médias e proporções, devem ser idênticas.</p>
- <p class="jst">Estatísticas com .purple[<b>survey</b>]:</p>
  - Consideram o plano amostral.
  - Não permitem manipulação direta dos dados com funções do pacote .purple[<b>dplyr</b>] e correlatos.
  - Custo computacional pode ser alto conforme à complexidade da operação e quantidade de dados.
- <p class="jst">Estatísticas com .purple[<b>survey/srvyr</b>]:</p>
  - Consideram o plano amostral.
  - Permitem usar funções do pacote .purple[<b>dplyr</b>] e correlatos.
  - Custo computacional pode ser alto conforme à complexidade da operação e quantidade de dados.
- <p class="jst">Estatísticas manualmente:</p>
  - Desconsidera diversas variáveis do plano amostral.
  - Podem combinar manipulação de dados usando .purple[<b>dplyr</b>] com funções que aplicam ponderação.
  - Custo computacional bem inferior em relação às funções dos pacotes .purple[<b>survey/srvyr</b>].

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 1:</b> Gere a estimativa do rendimento médio mensal de cada estado segundo a variável <b>V2007</b>. Use o pacote .purple[<b>srvyr</b>] e operações do .purple[<b>dplyr</b>].

```{r chunk25, cache=TRUE}
  rendimento_mensal <- pnadc2023_1trim |>
    group_by(UF, V2007) |>
    summarise(rendimento_medio = survey_mean(VD4020, na.rm = TRUE)) |>
    tidyr::drop_na() |> 
    arrange(UF)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 1:</b>

```{r chunk26, cache=TRUE}
  rendimento_mensal |>
    kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "330px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 1:</b> Gere gráficos de colunas do rendimento médio segundo a variável <b>V2007</b>, conforme:

```{r p1, message=FALSE, eval=FALSE}
  rendimento_mensal |> 
    ggplot(aes(UF, rendimento_medio)) +
    geom_col() +
    facet_wrap(~V2007, nrow = 1) +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 90))
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

```{r p1_out, ref.label="p1", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 2:</b> Gere as médias estimadas para o rendimento mensal e anos de estudo. Agrupe os dados por estado e pela variável <b>V2007</b>. Use os pacotes .purple[<b>srvyr</b>] e .purple[<b>dplyr</b>].

```{r chunk27, cache=TRUE}
  rendimento_mensal <- pnadc2023_1trim |>
    filter(VD3005 != "Sem instrução e menos de 1 ano de estudo") |>
    mutate(anos_de_estudo = as.numeric(gsub("\\D", "", VD3005))) |> 
    group_by(UF, V2007) |>
    summarise(rendimento_medio = survey_mean(VD4020, na.rm = TRUE, vartype = "ci"),
              anos_de_estudo = survey_mean(anos_de_estudo, na.rm = TRUE),
    ) |>
    tidyr::drop_na() |>
    arrange(UF)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 2:</b> 

```{r}
  rendimento_mensal |>
    kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "250px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 2:</b> Gere gráficos de dispersão para as estimativas do rendimento médio por anos de estudo segundo a variável <b>V2007</b>, conforme:

```{r p2, message=FALSE, eval=FALSE}
  rendimento_mensal |> 
    ggplot(aes(anos_de_estudo, rendimento_medio)) +
    geom_point() +
    facet_wrap(~V2007, nrow = 2) +
    theme_minimal()
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

```{r p2_out, ref.label="p2", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 2:</b> Gere sub-gráficos (segundo <b>V2007</b>) contendo as estimativas do rendimento médio mensal e intervalo de confiança em cada estado, conforme:

```{r p3, message=FALSE, eval=FALSE}
  rendimento_mensal |> 
    ggplot(aes(rendimento_medio, UF)) +
    geom_point() +
    geom_errorbar(
      aes(xmin = rendimento_medio_low,
          xmax = rendimento_medio_upp),
      width = 0.2) +
    facet_wrap(~V2007, nrow = 2) +
    theme_classic()
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

```{r p3_out, ref.label="p3", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 3:</b> Estime o rendimento mensal por nível de estudo (<b>VD3004</b>). Agrupe os dados por estado.


```{r chunk28, cache=TRUE}
  rendimento_mensal <- pnadc2023_1trim |> 
    filter(VD3004 != "NA") |>
    group_by(UF, VD3004) |>
    summarise(rendimento_medio = survey_mean(VD4020, na.rm = TRUE, vartype = "ci")) |>
    tidyr::drop_na() |>
    arrange(UF)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 3:</b>

```{r}
  rendimento_mensal |>
    kable() |> 
    kable_styling(bootstrap_options = c('striped', 'condensed')) |>
    scroll_box(width = "1050px", height = "250px")
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

<b>Exercício 3:</b> Gere gráficos de colunas com estimativas do rendimento médio por nível de estudo em cada estado, conforme:

```{r p4, message=FALSE, eval=FALSE}
  rendimento_mensal |> 
    ggplot(aes(rendimento_medio, VD3004)) +
    geom_col() +
    facet_wrap(~UF) +
    theme_minimal() +
    theme(axis.title.y = element_blank(), 
          axis.text.x = element_text(angle = 90),
          strip.text = element_text(size = 7))
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")` - Exercícios]

```{r p4_out, ref.label="p4", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

Considere os seguintes pacotes:

```{r, message=FALSE}
  library(geobr)
  library(sf)
  library(ggspatial)
```

Vamos carregar um mapa do brasil com a subdivisão dos estados:

```{r chunk29, cache=TRUE, message=FALSE}
  states <- read_state( year = 2020, showProgress = FALSE)
```

```{r, cache=TRUE}
  glimpse(states)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

<p class="jst">Vamos gerar novamente as estimativas dos rendimentos médios mensais conforme o Exercício 3, só que dessa vez, agruparemos os dados considerando a variável <b>code_state</b>.</p>

```{r chunk30, cache=TRUE}
  rendimento_mensal <- pnadc2023_1trim |>
    filter(VD3004 != "NA") |>
    group_by(code_state, VD3004) |>
    summarise(rendimento_medio = survey_mean(VD4020, na.rm = TRUE, vartype = "ci")) |>
    tidyr::drop_na()
```

```{r, cache=TRUE}
  glimpse(rendimento_mensal)
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

Agora, adicionaremos os dados de rendimento médio mensal ao conjunto de dados do mapa.

```{r chunk31, cache=TRUE}
  states <- dplyr::left_join(states, rendimento_mensal, by = "code_state")
```

<p class="jst">Finalmente, podemos produzir um mapa usando o .purple[ggplot2], conforme:</p>

```{r p5, message=FALSE, eval=FALSE}
  titulo <- paste0("Rendimento médio mensal para indivíduos com nível superior completo,\n",
                   "no primeiro trimestre de 2023")
  states |> filter(VD3004 == "Superior completo") |> ggplot() +
    geom_sf(data=states, aes(fill=rendimento_medio), color=NA) +
    labs(subtitle = titulo, size=8) +
    scale_fill_distiller(palette = "Spectral", name="Rendimento Médio") +
    theme_minimal() + 
    ggspatial::annotation_scale()
```

---
class: left, top
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

```{r p5_out, ref.label="p5", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

<p class="jst">Também, podemos produzir um mapa, conforme:</p>

```{r p6, message=FALSE, eval=FALSE}
  states |> ggplot() +
    geom_sf(data=states, aes(fill=rendimento_medio), color=NA) + 
    facet_wrap(~VD3004) +
    labs(subtitle="Rendimento médio mensal, no primeiro trimestre de 2023", size=8) +
    scale_fill_distiller(palette = "Spectral", name="Rendimento Médio") +
    theme_classic() +
    theme(axis.text = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          strip.text = element_text(size = 6))
```

---
class: left, top
### .orange[Microdados da PNAD Contínua `r icons::ionicons("earth-outline")` - visualização espacial]

```{r p6_out, ref.label="p6", echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', out.height= "500px", out.width="800px"}
```

---
### .orange[Microdados da PNAD Contínua `r icons::ionicons("bar-chart-outline")`]

<p class="jst">Há uma diversidade de bons materiais que orientam o uso dos microdados da PNAD Contínua através do R: </p>

- <p class="jst">Material <A href="https://rpubs.com/gabriel-assuncao-ibge/pnadc">.purple[online]</A> desenvolvido por um dos criadores do pacote .purple[<b>PNADcIBGE</b>].

- <p class="jst"> Livro  <A href="https://repositorio.ufrn.br/bitstream/123456789/48507/1/PorDentrodaPNADContinua_Trov%C3%A3o_SilvaJ%C3%BAnior_2022.pdf">.purple["POR DENTRO DA PNAD CONTÍNUA: Uma introdução ao tratamento de dados usando o R"]</A>.
- <p class="jst">Curso de R disponível no repositório do Git Hub: <A href="https://github.com/leobarone/cebrap_lab_cetic_programacao_r/tree/master">.purple[Introdução à Programação em R]</b></A>. 
- <p class="jst">Material <A href="https://rpubs.com/amrofi/microdados_pnadc_srvyr/">.purple[online]</A>.

---
exclude: TRUE
class: left, top

### .orange[Referências]

```{r, load_refs, echo=FALSE}
library(RefManageR)
bib <- ReadBib("./files/02-mybib.bib", check = FALSE)
generateReferences <- function(bib) {
  for(i in 1:length(bib)) { 
    print(bib[i], .opts = list(check.entries = FALSE, style = "html", bib.style = "authoryear"))
  }
}
```

```{r, print_refs, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
writeLines('.small[')
generateReferences(bib)
writeLines(']')
```

---
class: center, middle

background-image: url(figures/template_endpage_2.png)
background-size: contain

.center[.large[<b> Metotologias Informacionais com `r icon_style( icons::simple_icons("r"), scale = 2)`</b> ]]

.xxlarge[<b style="color:MidnightBlue "> Muito Obrigado pela Atenção!</b>]
  
